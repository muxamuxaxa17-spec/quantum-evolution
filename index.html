<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Evolution</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ... (—Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... */
    </style>
</head>
<body>
    <div class="mobile-container">
        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å —Ä–µ—Å—É—Ä—Å–æ–≤ -->
        <div class="stats-bar">
            <div class="resource">‚ö° <span id="energy">1,250</span></div>
            <div class="resource">üß† <span id="knowledge">450</span></div>
            <div class="resource">üíé <span id="fragments">0</span></div>
        </div>

        <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ Telegram -->
        <div id="tg-welcome" style="display: none; text-align: center; margin-bottom: 20px;">
            <h3 id="tg-username">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Quantum Evolution!</h3>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å -->
        <div class="progress-section">
            <div class="size-display" id="current-size">1.6e-35 –º</div>
            <div class="stage-display" id="current-stage">–ü–ª–∞–Ω–∫–æ–≤—Å–∫–∞—è –¥–ª–∏–Ω–∞</div>
            <div class="era-display" id="current-era">–ö–≤–∞–Ω—Ç–æ–≤–∞—è —ç—Ä–∞</div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="stage-progress"></div>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="action-section">
            <button class="main-action-btn" id="quantum-fluctuation">
                ‚öõÔ∏è<br>–ö–≤–∞–Ω—Ç–æ–≤–∞—è<br>—Ñ–ª—É–∫—Ç—É–∞—Ü–∏—è
            </button>
        </div>

        <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="quick-actions">
            <button class="quick-btn" id="auto-growth">ü§ñ<br>–ê–≤—Ç–æ-—Ä–æ—Å—Ç</button>
            <button class="quick-btn" id="research-btn">üî¨<br>–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è</button>
            <button class="quick-btn" id="prestige-btn">üí•<br>–ë–æ–ª—å—à–æ–π –≤–∑—Ä—ã–≤</button>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è Telegram -->
        <button class="tg-button" id="tg-share" style="display: none;">
            üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
        </button>

        <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div id="debug-info" style="display: none; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 10px; margin-top: 20px; font-size: 12px;">
            <h4>–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h4>
            <div id="debug-content"></div>
        </div>
    </div>

    <!-- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="bottom-nav">
        <button class="nav-btn active" data-tab="main">üåå</button>
        <button class="nav-btn" data-tab="research">üî¨</button>
        <button class="nav-btn" data-tab="progress">üìä</button>
        <button class="nav-btn" data-tab="library">üìö</button>
    </nav>

    <script>
        // === TELEGRAM INIT ===
        let tg = window.Telegram?.WebApp;
        let isTelegram = false;

        // –í–∫–ª—é—á–∞–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        const debugMode = true;
        function debugLog(message) {
            if (debugMode) {
                console.log(message);
                const debugDiv = document.getElementById('debug-info');
                const debugContent = document.getElementById('debug-content');
                if (debugDiv && debugContent) {
                    debugDiv.style.display = 'block';
                    debugContent.innerHTML += message + '<br>';
                }
            }
        }

        debugLog('üöÄ –ù–∞—á–∞–ª–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏...');

        if (tg) {
            debugLog('‚úÖ Telegram Web App –æ–±–Ω–∞—Ä—É–∂–µ–Ω');
            isTelegram = true;
            tg.expand(); // –†–∞—Å–∫—Ä—ã–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
            tg.enableClosingConfirmation(); // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
            const user = tg.initDataUnsafe?.user;
            if (user) {
                document.getElementById('tg-welcome').style.display = 'block';
                document.getElementById('tg-username').textContent = `üëã –ü—Ä–∏–≤–µ—Ç, ${user.first_name}!`;
                document.getElementById('tg-share').style.display = 'block';
                debugLog('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ' + user.first_name);
            } else {
                debugLog('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω');
            }
        } else {
            debugLog('‚ùå Telegram Web App –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω, —Ä–∞–±–æ—Ç–∞–µ–º –≤ –±—Ä–∞—É–∑–µ—Ä–µ');
        }

        // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò–ì–†–´ ===
        const stages = [
            // ... (stages –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...
        ];

        const eras = {
            // ... (eras –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...
        };

        // === –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´ ===
        let gameState = {
            size: 1.6e-35,
            currentStage: 0,
            energy: 1250,
            knowledge: 450,
            quantumFragments: 0,
            autoGrowth: 0,
            growthMultiplier: 1,
            totalClicks: 0,
            totalBigBangs: 0
        };

        // === –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
        function initGame() {
            debugLog('üéÆ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã...');
            loadGame();
            setupEventListeners();
            startGameLoop();
            updateDisplay();
            debugLog('‚úÖ –ò–≥—Ä–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞!');
        }

        function loadGame() {
            try {
                if (isTelegram) {
                    debugLog('üíæ –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Telegram Cloud...');
                    tg.CloudStorage.getItem('quantum_evolution', (err, data) => {
                        if (err) {
                            debugLog('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Telegram Cloud: ' + err);
                            loadFromLocalStorage();
                        } else if (data) {
                            debugLog('‚úÖ –î–∞–Ω–Ω—ã–µ –∏–∑ Telegram Cloud –ø–æ–ª—É—á–µ–Ω—ã');
                            const loaded = JSON.parse(data);
                            Object.assign(gameState, loaded);
                            updateDisplay();
                        } else {
                            debugLog('‚ÑπÔ∏è –í Telegram Cloud –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage');
                            loadFromLocalStorage();
                        }
                    });
                } else {
                    loadFromLocalStorage();
                }
            } catch (e) {
                debugLog('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e);
            }
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('quantumEvolution');
            if (saved) {
                debugLog('üíæ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage');
                const loaded = JSON.parse(saved);
                Object.assign(gameState, loaded);
            } else {
                debugLog('‚ÑπÔ∏è –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π, –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é –∏–≥—Ä—É');
            }
        }

        function saveGame() {
            try {
                const saveData = JSON.stringify(gameState);
                debugLog('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–≥—Ä—ã...');
                
                if (isTelegram) {
                    tg.CloudStorage.setItem('quantum_evolution', saveData, (err) => {
                        if (err) {
                            debugLog('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Telegram Cloud: ' + err);
                            localStorage.setItem('quantumEvolution', saveData);
                        } else {
                            debugLog('‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ Telegram Cloud');
                        }
                    });
                } else {
                    localStorage.setItem('quantumEvolution', saveData);
                    debugLog('‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ localStorage');
                }
            } catch (e) {
                debugLog('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + e);
            }
        }

        // ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º debugLog –≤ –∫–ª—é—á–µ–≤—ã–µ –º–µ—Å—Ç–∞) ...

        function setupEventListeners() {
            debugLog('üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π...');

            // –û—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞
            const mainBtn = document.getElementById('quantum-fluctuation');
            mainBtn.addEventListener('click', handleQuantumFluctuation);
            mainBtn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                handleQuantumFluctuation();
            });

            // –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏
            document.getElementById('auto-growth').addEventListener('click', function() {
                showMessage("ü§ñ –ê–≤—Ç–æ-—Ä–æ—Å—Ç", "–°–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ!");
            });
            
            document.getElementById('research-btn').addEventListener('click', function() {
                showMessage("üî¨ –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è", "–°–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ!");
            });
            
            document.getElementById('prestige-btn').addEventListener('click', function() {
                showMessage("üí• –ë–æ–ª—å—à–æ–π –≤–∑—Ä—ã–≤", "–°–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ!");
            });

            // –ö–Ω–æ–ø–∫–∞ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –≤ Telegram
            document.getElementById('tg-share').addEventListener('click', shareProgress);

            // –ù–∞–≤–∏–≥–∞—Ü–∏—è
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tab = this.dataset.tab;
                    switchTab(tab);
                });
            });

            debugLog('‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
        }

        function shareProgress() {
            const currentStage = stages[gameState.currentStage];
            const message = `üåå Quantum Evolution\nüìè –ú–æ–π —Ä–∞–∑–º–µ—Ä: ${formatSize(gameState.size)}\nüéØ –≠—Ç–∞–ø: ${currentStage.name}\n‚ö° –≠–Ω–µ—Ä–≥–∏—è: ${Math.floor(gameState.energy)}\n\n–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ —ç–≤–æ–ª—é—Ü–∏–∏!`;
            
            if (isTelegram) {
                tg.shareMessage(message);
            } else {
                // –î–ª—è –±—Ä–∞—É–∑–µ—Ä–∞
                if (navigator.share) {
                    navigator.share({
                        title: 'Quantum Evolution',
                        text: message,
                        url: window.location.href
                    });
                } else {
                    navigator.clipboard.writeText(message).then(() => {
                        showMessage("üìã", "–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!");
                    });
                }
            }
        }

        function startGameLoop() {
            debugLog('üîÅ –ó–∞–ø—É—Å–∫ –∏–≥—Ä–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞...');
            setInterval(() => {
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–æ—Å—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å)
                if (gameState.autoGrowth > 0) {
                    gameState.size += gameState.autoGrowth * gameState.growthMultiplier;
                    checkStageProgression();
                    updateDisplay();
                }
            }, 1000);

            // –ê–≤—Ç–æ-—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(saveGame, 30000);
        }

        function handleQuantumFluctuation() {
            const baseGrowth = 1.6e-37;
            gameState.size += baseGrowth * gameState.growthMultiplier;
            gameState.energy += 1;
            gameState.knowledge += 0.5;
            gameState.totalClicks++;
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏
            const btn = document.getElementById('quantum-fluctuation');
            btn.style.transform = 'scale(0.95)';
            setTimeout(() => btn.style.transform = 'scale(1)', 100);
            
            checkStageProgression();
            updateDisplay();
            
            debugLog('‚öõÔ∏è –ö–≤–∞–Ω—Ç–æ–≤–∞—è —Ñ–ª—É–∫—Ç—É–∞—Ü–∏—è! –†–∞–∑–º–µ—Ä: ' + gameState.size);
        }

        // ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É –∫–æ–≥–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>